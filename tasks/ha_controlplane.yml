    - name: Initializing the controlplane using Docker
      shell: >
        kubeadm init
        --apiserver-advertise-address {{ inventory_hostname }}
        --pod-network-cidr {{ pod_nw_cidr }}
        --service-cidr {{ service_nw_cidr }}
        --control-plane-endpoint {{ ha_virtual_ip }}:{{ haproxy_apiserver_port }}
        --upload-certs > /root/controlplane.log
      async: 600
      poll: 5
      when: cri == 'docker'

    - name: Initializing the controlplane using ContainerD
      shell: >
        kubeadm init
        --apiserver-advertise-address {{ inventory_hostname }}
        --pod-network-cidr {{ pod_nw_cidr }}
        --service-cidr {{ service_nw_cidr }}
        --cri-socket /run/containerd/containerd.sock
        --control-plane-endpoint {{ ha_virtual_ip }}:{{ haproxy_apiserver_port }}
        --upload-certs > /root/controlplane.log
      async: 600
      poll: 5
      when: cri == 'containerd'

    - name: Initializing the controlplane using CRI-O
      shell: >
        kubeadm init
        --apiserver-advertise-address {{ inventory_hostname }}
        --pod-network-cidr {{ pod_nw_cidr }}
        --service-cidr {{ service_nw_cidr }}
        --cri-socket unix:///var/run/crio/crio.sock
        --control-plane-endpoint {{ ha_virtual_ip }}:{{ haproxy_apiserver_port }}
        --upload-certs > /root/controlplane.log
      async: 600
      poll: 5
      when: cri == 'cri-o'

    - name: Adding details to masters join script
      shell: |
        set -o pipefail
        tail -n12 < ~/controlplane.log | head -n3 >> ~/join_masters.sh
      args:
        executable: /bin/bash
      changed_when: true

    - name: Adding details to workers join script
      shell: 'tail -n2 ~/controlplane.log >> ~/join_workers.sh'
      changed_when: true

    - name: Copying masters join script to Controller
      fetch:
        src: ~/join_masters.sh
        dest: ./configs/join_masters.sh
        flat: yes

    - name: Copying workers join script to Controller
      fetch:
        src: ~/join_workers.sh
        dest: ./configs/join_workers.sh
        flat: yes
